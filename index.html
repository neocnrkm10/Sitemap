<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeonVerse - Secure Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        neon: {
                            purple: '#8b5cf6',
                            blue: '#3b82f6',
                            dark: '#050505'
                        }
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        mono: ['Rajdhani', 'monospace'],
                    },
                    animation: {
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                    },
                    keyframes: {
                        popIn: {
                            '0%': { opacity: '0', transform: 'scale(0.8)' },
                            '100%': { opacity: '1', transform: 'scale(1)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* CRITICAL MOBILE FIXES */
        html, body { 
            height: 100%; 
            height: 100dvh; /* Dynamic viewport height for mobile browsers */
            overflow: hidden; 
            background-color: #000; 
            color: #e2e8f0; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        .cyber-bg {
            background: linear-gradient(180deg, #000000 0%, #0f0720 100%);
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
        }

        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.5; pointer-events: none;}

        .glass-panel {
            background: rgba(10, 10, 12, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(139, 92, 246, 0.15);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }
        
        .glass-input {
            background: rgba(20, 20, 30, 0.6);
            border: 1px solid rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            font-family: 'Outfit', sans-serif;
        }
        .glass-input:focus { border-color: #8b5cf6; outline: none; box-shadow: 0 0 15px rgba(139, 92, 246, 0.15); }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4c1d95; border-radius: 2px; }

        .bubble-me { 
            background: linear-gradient(135deg, #4c1d95 0%, #2563eb 100%);
            color: white; 
            border-radius: 18px 18px 4px 18px; 
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
        }
        .bubble-other { 
            background: #1e1e24; 
            color: #e2e8f0; 
            border-radius: 18px 18px 18px 4px; 
            border: 1px solid #2d2d35;
        }

        .reaction-menu {
            position: absolute;
            background: #0f0f12;
            border: 1px solid #3b82f6;
            border-radius: 50px;
            padding: 6px 12px;
            display: none; 
            gap: 12px;
            top: -50px; 
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
            z-index: 100; 
            white-space: nowrap;
        }
        .reaction-menu.active { display: flex; animation: popIn 0.2s ease-out; }

        .no-select { user-select: none; -webkit-user-select: none; }
    </style>
</head>
<body class="flex flex-col font-sans">

    <div class="cyber-bg"></div>
    <div id="canvas-container"></div>

    <div id="share-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-4 animate-pop-in">
        <div class="glass-panel p-6 rounded-2xl border border-purple-500/30 max-w-sm w-full relative">
            <h3 class="text-xl font-bold text-white mb-1">Invite Agent</h3>
            <p class="text-gray-400 text-xs mb-4">Share this frequency key to establish connection.</p>
            
            <div class="glass-input rounded-lg p-3 flex items-center justify-between mb-4 bg-black/50">
                <span class="text-xs text-purple-400 font-mono truncate w-48" id="share-link-text">...</span>
                <button onclick="copyFullLink(true)" class="text-white hover:text-purple-400 font-bold text-xs uppercase tracking-wider transition">COPY</button>
            </div>

            <button onclick="closeShareModal()" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-purple-900/20">
                Enter Channel
            </button>
        </div>
    </div>

    <div id="landing-page" class="flex-1 flex flex-col items-center justify-center p-4 z-10 animate-pop-in overflow-y-auto">
        <div class="glass-panel rounded-3xl p-8 md:p-12 w-full max-w-md text-center relative overflow-hidden my-auto">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 via-blue-500 to-purple-500"></div>
            
            <div class="mb-6 flex justify-center relative">
                <div class="absolute inset-0 bg-blue-500 blur-3xl opacity-20 rounded-full"></div>
                <i class="fas fa-ghost text-5xl text-purple-500 z-10"></i>
            </div>

            <h1 class="text-4xl font-bold text-white mb-2" id="landing-title">ChatWith<span class="text-blue-500">CNR</span></h1>
            <p class="text-slate-500 text-sm mb-6 font-mono" id="landing-subtitle">SECURE MESSAGING PROTOCOL</p>

            <div class="mb-6 text-xs text-amber-500/90 bg-amber-900/20 border border-amber-500/20 p-3 rounded-lg text-center leading-relaxed">
                <i class="fas fa-shield-halved mr-1"></i> 
                <strong>Ephemeral Chat:</strong> History is not saved. You will NOT see messages sent before you joined.
            </div>

            <div class="space-y-4 text-left">
                <div>
                    <input type="text" id="username-input" placeholder="Choose Identity..." class="glass-input w-full px-5 py-4 rounded-xl text-lg placeholder-slate-600 pointer-events-auto">
                </div>
                
                <button onclick="createChat()" id="action-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-900/30 transition flex items-center justify-center gap-2">
                    <span id="action-btn-text">Create Room</span> <i class="fas fa-arrow-right text-xs"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="chat-page" class="hidden flex-col h-full w-full z-10 relative">
        <header class="glass-panel border-none px-5 py-4 flex justify-between items-center bg-black/60 rounded-b-2xl mx-2 mt-2 shrink-0">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <div class="w-2.5 h-2.5 bg-purple-500 rounded-full box-shadow shadow-[0_0_10px_#8b5cf6]"></div>
                </div>
                <div>
                    <h2 class="text-md font-bold text-white tracking-wide">ROOM <span class="text-purple-500 font-mono" id="room-display">#000</span></h2>
                    <div onclick="openShareModal()" class="text-[10px] text-slate-500 cursor-pointer hover:text-blue-400 transition font-mono flex items-center gap-1">
                        <i class="fas fa-user-plus"></i> <span>ADD USER</span>
                    </div>
                </div>
            </div>
            <button onclick="leaveChat()" class="w-9 h-9 rounded-full bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white transition flex items-center justify-center">
                <i class="fas fa-times"></i>
            </button>
        </header>

        <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4 w-full scroll-smooth">
            <div class="text-center py-6">
                <span class="px-3 py-1 rounded-full bg-purple-900/20 border border-purple-500/20 text-[10px] text-purple-400 font-mono">
                    ENCRYPTED CONNECTION ESTABLISHED
                </span>
            </div>
        </div>

        <div id="reply-preview" class="hidden glass-panel mx-2 mb-2 rounded-xl p-3 flex justify-between items-center bg-black/80 border border-purple-500/30 shrink-0">
            <div class="flex items-center gap-3 overflow-hidden">
                <div class="w-1 h-8 bg-purple-500 rounded-full"></div>
                <div class="flex flex-col text-sm">
                    <span class="text-purple-400 font-bold text-xs" id="reply-to-user">User</span>
                    <span class="text-slate-400 truncate max-w-[200px] text-xs" id="reply-to-text">Message...</span>
                </div>
            </div>
            <button onclick="cancelReply()" class="text-slate-500 hover:text-white px-2"><i class="fas fa-times"></i></button>
        </div>

        <footer class="p-3 bg-transparent w-full z-50 shrink-0">
            <div class="glass-panel rounded-2xl p-2 flex items-end gap-2 relative bg-black/80">
                <input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleImageUpload()">
                
                <button onclick="document.getElementById('image-input').click()" class="w-10 h-10 text-purple-400 hover:text-white transition rounded-full hover:bg-white/10 flex items-center justify-center shrink-0">
                    <i class="fas fa-image"></i>
                </button>

                <button id="record-btn" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()" class="w-10 h-10 text-blue-400 hover:text-red-500 transition rounded-full hover:bg-white/10 flex items-center justify-center shrink-0">
                    <i class="fas fa-microphone"></i>
                </button>

                <div class="flex-1 relative py-2">
                    <textarea id="message-input" rows="1" class="w-full bg-transparent text-white text-base px-2 focus:outline-none resize-none max-h-32 placeholder-slate-600 font-sans pointer-events-auto" placeholder="Type a message..." oninput="autoResize(this)" onkeydown="handleEnter(event)" style="touch-action: manipulation;"></textarea>
                </div>

                <button onclick="sendTextMessage()" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl w-10 h-10 flex items-center justify-center shadow-lg hover:scale-105 transition shrink-0">
                    <i class="fas fa-paper-plane text-xs"></i>
                </button>
            </div>
        </footer>
    </div>

    <div id="overlay" class="hidden fixed inset-0 z-40 bg-transparent" onclick="closeAllReactions()"></div>

    <script>
        // --- 1. OPTIMIZED THREE.JS ---
        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: false });
            
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio > 1 ? 1.5 : 1);
            container.appendChild(renderer.domElement);

            const count = 600; 
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(count * 3);
            const colors = new Float32Array(count * 3);

            for(let i = 0; i < count * 3; i+=3) {
                positions[i] = (Math.random() - 0.5) * 25;
                positions[i+1] = (Math.random() - 0.5) * 25;
                positions[i+2] = (Math.random() - 0.5) * 25;

                const mix = Math.random();
                if(mix < 0.5) {
                    colors[i] = 0.5; colors[i+1] = 0.3; colors[i+2] = 0.9;
                } else {
                    colors[i] = 0.2; colors[i+1] = 0.4; colors[i+2] = 1.0;
                }
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({
                size: 0.05,
                vertexColors: true,
                transparent: true,
                opacity: 0.8,
                sizeAttenuation: true
            });

            const particles = new THREE.Points(geometry, material);
            scene.add(particles);
            camera.position.z = 5;

            function animate() {
                requestAnimationFrame(animate);
                particles.rotation.y += 0.001;
                particles.rotation.x += 0.0005;
                renderer.render(scene, camera);
            }
            animate();

            // Handle Resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }
        initThreeJS();

        // --- 2. CHAT LOGIC ---
        const socket = io('https://chatsocket-6koy.onrender.com', { transports: ['websocket'], reconnection: true });
        let currentUser = "";
        let currentRoom = "";
        let replyContext = null; 
        const messageStore = {};
        let pressTimer;
        let isScrolling = false;

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const roomParam = params.get('room');
            if (roomParam) {
                currentRoom = roomParam;
                document.getElementById('action-btn-text').innerText = "Join Room";
                document.getElementById('action-btn').classList.remove('bg-blue-600', 'hover:bg-blue-500');
                document.getElementById('action-btn').classList.add('bg-purple-600', 'hover:bg-purple-500');
                document.getElementById('landing-subtitle').innerText = `REQ: JOINING CHANNEL #${roomParam}`;
            }
        };

        function createChat() {
            const username = document.getElementById('username-input').value.trim();
            if (!username) return alert("Identity required.");
            currentUser = username;
            
            if (!currentRoom) {
                currentRoom = Math.random().toString(36).substring(2, 8).toUpperCase();
                const newUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}?room=${currentRoom}`;
                window.history.pushState({path: newUrl}, '', newUrl);
            }
            
            document.getElementById('room-display').innerText = currentRoom;
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('chat-page').classList.replace('hidden', 'flex');
            
            socket.emit('join_room', { username: currentUser, room: currentRoom });
            const sysPayload = { type: 'system', text: `${currentUser} joined the chat` };
            socket.emit('message', { msg: JSON.stringify(sysPayload) });

            openShareModal();
            // Focus on input immediately
            setTimeout(() => document.getElementById('message-input').focus(), 500);
        }

        function openShareModal() {
            document.getElementById('share-link-text').innerText = window.location.href;
            document.getElementById('share-modal').classList.remove('hidden');
        }
        function closeShareModal() { document.getElementById('share-modal').classList.add('hidden'); }
        function copyFullLink(fromModal) {
            navigator.clipboard.writeText(window.location.href);
            if(fromModal) {
                const btn = document.querySelector('#share-modal button.text-white');
                const original = btn.innerText; btn.innerText = "COPIED"; setTimeout(()=>btn.innerText=original, 2000);
            }
        }
        function leaveChat() { 
            const sysPayload = { type: 'system', text: `${currentUser} left the chat` };
            socket.emit('message', { msg: JSON.stringify(sysPayload) });
            setTimeout(() => window.location.href = window.location.pathname, 100);
        }
        
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

        function sendTextMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;
            const payload = { type: 'text', id: generateId(), content: text, replyTo: replyContext, timestamp: new Date().toISOString() };
            socket.emit('message', { msg: JSON.stringify(payload) });
            input.value = ""; input.style.height = 'auto'; cancelReply();
            input.focus();
        }

        socket.on('message', (data) => {
            if(data.user === "Server" && !data.msg.startsWith('{')) return; 
            try {
                const payload = JSON.parse(data.msg);
                if (payload.type === 'system') renderSystemMessage(payload.text);
                else if (payload.type === 'text') renderMessage(data.user, payload);
                else if (payload.type === 'reaction-update') handleReaction(payload);
            } catch (e) { 
                renderMessage(data.user, { type: 'text', id: generateId(), content: data.msg }); 
            }
        });

        socket.on('image', (data) => renderMessage(data.user, { type: 'image', id: generateId(), content: data.img }));
        socket.on('voice', (data) => renderMessage(data.user, { type: 'voice', id: generateId(), content: data.voice }));

        function renderSystemMessage(text) {
            const container = document.getElementById('messages-container');
            const div = document.createElement('div');
            div.className = "flex justify-center my-2 animate-pop-in";
            div.innerHTML = `<span class="text-[10px] text-slate-500 bg-black/40 px-3 py-1 rounded-full border border-slate-800">${text}</span>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function renderMessage(user, data) {
            const container = document.getElementById('messages-container');
            const isMe = user === currentUser;
            const msgId = data.id || generateId();
            messageStore[msgId] = { user, ...data };

            const wrapper = document.createElement('div');
            wrapper.id = `msg-${msgId}`;
            wrapper.className = `flex w-full ${isMe ? 'justify-end' : 'justify-start'} relative animate-pop-in group`;

            const avatar = `<div class="w-8 h-8 rounded-full bg-slate-800 border border-slate-600 flex items-center justify-center text-slate-300 text-xs font-bold mr-2 mt-auto">${user.substring(0,2).toUpperCase()}</div>`;

            let contentHtml = "";
            if (data.type === 'text') contentHtml = `<p class="whitespace-pre-wrap leading-relaxed text-sm">${data.content}</p>`;
            else if (data.type === 'image') contentHtml = `<img src="${data.content}" class="rounded-lg max-w-[200px] border border-white/10">`;
            else if (data.type === 'voice') contentHtml = `<audio controls src="${data.content}" class="h-8 w-48 opacity-80 invert"></audio>`;

            let replyHtml = "";
            if (data.replyTo) {
                replyHtml = `
                    <div class="mb-2 text-[10px] bg-black/20 p-2 rounded border-l-2 border-white/50 cursor-pointer" onclick="scrollToMessage('${data.replyTo.id}')">
                        <span class="font-bold opacity-75">${data.replyTo.user}</span>
                        <div class="truncate opacity-60">${data.replyTo.text.substring(0, 25)}...</div>
                    </div>
                `;
            }

            const reactionMenu = `
                <div id="reaction-menu-${msgId}" class="reaction-menu ${isMe ? 'right-0' : 'left-0'}">
                    <button onclick="sendReaction('${msgId}', '')" class="hover:scale-125 transition text-lg"></button>
                    <button onclick="sendReaction('${msgId}', '')" class="hover:scale-125 transition text-lg"></button>
                    <button onclick="sendReaction('${msgId}', '')" class="hover:scale-125 transition text-lg"></button>
                    <button onclick="sendReaction('${msgId}', '')" class="hover:scale-125 transition text-lg"></button>
                    <button onclick="sendReaction('${msgId}', '')" class="hover:scale-125 transition text-lg"></button>
                </div>
            `;

            const bubbleHtml = `
                <div class="${isMe ? 'bubble-me' : 'bubble-other'} px-4 py-3 relative no-select cursor-pointer"
                     onmousedown="handlePressStart('${msgId}')" 
                     onmouseup="handlePressEnd()" 
                     onmouseleave="handlePressEnd()"
                     ontouchstart="handlePressStart('${msgId}')" 
                     ontouchend="handlePressEnd()"
                     ontouchmove="handleTouchMove()"
                     oncontextmenu="event.preventDefault(); return false;">
                    ${replyHtml}
                    ${contentHtml}
                    <div class="flex items-center justify-between mt-1 gap-2">
                        <div class="text-[9px] opacity-50 font-mono">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                         <button onclick="triggerReply('${msgId}')" class="text-white/40 hover:text-white transition">
                            <i class="fas fa-reply text-[10px]"></i>
                        </button>
                    </div>
                </div>
            `;

            wrapper.innerHTML = `
                ${!isMe ? avatar : ''}
                <div class="relative max-w-[80%] md:max-w-[65%]">
                    ${reactionMenu}
                    ${bubbleHtml}
                    <div id="reactions-${msgId}" class="absolute -bottom-3 ${isMe ? 'right-0' : 'left-0'} flex gap-1 pointer-events-none z-10 flex-wrap"></div>
                </div>
            `;

            container.appendChild(wrapper);
            container.scrollTop = container.scrollHeight;
        }

        // --- 3. REACTION LOGIC ---
        function handlePressStart(msgId) {
            isScrolling = false; 
            pressTimer = setTimeout(() => {
                if (!isScrolling) {
                    showReactionMenu(msgId);
                    if (navigator.vibrate) navigator.vibrate(50);
                }
            }, 600); 
        }

        function handlePressEnd() { clearTimeout(pressTimer); }
        function handleTouchMove() { isScrolling = true; clearTimeout(pressTimer); }

        function showReactionMenu(msgId) {
            closeAllReactions();
            const menu = document.getElementById(`reaction-menu-${msgId}`);
            if(menu) {
                menu.classList.add('active');
                document.getElementById('overlay').classList.remove('hidden');
            }
        }

        function closeAllReactions() {
            document.querySelectorAll('.reaction-menu').forEach(el => el.classList.remove('active'));
            document.getElementById('overlay').classList.add('hidden');
        }

        function sendReaction(msgId, emoji) {
            const payload = { type: 'reaction-update', targetId: msgId, emoji: emoji, fromUser: currentUser };
            socket.emit('message', { msg: JSON.stringify(payload) });
            closeAllReactions();
        }

        function handleReaction(payload) {
            const container = document.getElementById(`reactions-${payload.targetId}`);
            if (container) {
                const badge = document.createElement('div');
                badge.className = "bg-slate-800 text-[10px] px-1.5 py-0.5 rounded-full border border-slate-600 shadow-sm animate-pop-in z-20 mb-1";
                badge.innerText = payload.emoji;
                container.appendChild(badge);
            }
        }

        // --- REPLY & UTILS ---
        function triggerReply(msgId) {
            const original = messageStore[msgId];
            if (!original) return;
            replyContext = { id: msgId, user: original.user, text: original.type === 'text' ? original.content : '[MEDIA]' };
            document.getElementById('reply-preview').classList.replace('hidden', 'flex');
            document.getElementById('reply-to-user').innerText = replyContext.user;
            document.getElementById('reply-to-text').innerText = replyContext.text;
            document.getElementById('message-input').focus();
        }
        function cancelReply() { replyContext = null; document.getElementById('reply-preview').classList.replace('flex', 'hidden'); }
        function scrollToMessage(id) {
            const el = document.getElementById(`msg-${id}`);
            if(el) { 
                el.scrollIntoView({behavior:'smooth', block:'center'}); 
                const bubble = el.querySelector('.bubble-me, .bubble-other');
                bubble.style.filter = "brightness(1.5)";
                setTimeout(()=> bubble.style.filter = "brightness(1)", 1000);
            }
        }
        function autoResize(textarea) { textarea.style.height = 'auto'; textarea.style.height = textarea.scrollHeight + 'px'; }
        function handleEnter(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendTextMessage(); } }

        // --- MEDIA ---
        function handleImageUpload() {
            const file = document.getElementById('image-input').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => socket.emit('image', { img: e.target.result });
                reader.readAsDataURL(file);
            }
        }
        
        let mediaRecorder; let audioChunks = [];
        async function startRecording() {
            const btn = document.getElementById('record-btn');
            btn.classList.add('text-red-500', 'animate-pulse');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.start();
            } catch (err) { alert("Mic permission denied."); btn.classList.remove('text-red-500', 'animate-pulse'); }
        }
        function stopRecording() {
            const btn = document.getElementById('record-btn');
            btn.classList.remove('text-red-500', 'animate-pulse');
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onloadend = () => socket.emit('voice', { voice: reader.result });
                    reader.readAsDataURL(blob);
                };
            }
        }
    </script>
</body>
</html>
