<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatWithCNR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Modern scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Reaction Pulse */
        .reaction-anim { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        /* Recording indicator */
        .recording-active { animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col overflow-hidden selection:bg-teal-100">

    <div id="landing-page" class="flex-1 flex flex-col items-center justify-center p-6 fade-in">
        <div class="max-w-md w-full bg-white rounded-xl shadow-2xl p-8 border border-gray-100">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-teal-700 tracking-tight">ChatWithCNR</h1>
                <p class="text-gray-400 text-sm mt-1">Real-time. Encrypted in Transit. Ephemeral.</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Username</label>
                    <input type="text" id="username-input" placeholder="Enter your display name" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 transition bg-gray-50 focus:bg-white">
                </div>

                <button onclick="createChat()" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-4 rounded-lg transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                    <i class="fas fa-plus-circle"></i> Create Temporary Chatroom
                </button>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-100 text-xs text-gray-500 space-y-2">
                <p class="flex items-center gap-2"><i class="fas fa-server text-teal-500"></i> Local Memory: Chatroom is deleted when server restarts or everyone leaves.</p>
                <p class="flex items-center gap-2"><i class="fas fa-lock text-teal-500"></i> Links shared securely via HTTPS.</p>
            </div>
        </div>
        <div class="mt-6 text-gray-400 text-xs font-medium">Created by cnr krishna khanal</div>
    </div>

    <div id="chat-page" class="hidden flex-col h-full bg-white">
        <header class="bg-white border-b px-6 py-3 flex justify-between items-center shadow-sm z-20">
            <div class="flex flex-col">
                <h2 class="text-lg font-bold text-teal-800">ChatWithCNR</h2>
                <div class="flex items-center gap-2 text-xs bg-gray-100 px-2 py-1 rounded-md cursor-pointer hover:bg-gray-200 transition" onclick="copyFullLink()">
                    <span class="text-gray-500 font-medium">Link:</span>
                    <span id="share-link-text" class="text-teal-600 truncate max-w-[200px] md:max-w-[400px]">...</span>
                    <i class="fas fa-copy text-gray-400"></i>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="active-users" class="hidden md:flex -space-x-2">
                    </div>
                <button onclick="leaveChat()" class="text-gray-400 hover:text-red-500 transition px-2">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </header>

        <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-6 bg-slate-50">
            <div class="text-center text-xs text-gray-400 my-4">
                <span class="bg-gray-200 px-3 py-1 rounded-full">Encrypted in transit & Ephemeral</span>
            </div>
            </div>

        <div id="reply-preview" class="hidden bg-gray-50 border-t border-teal-100 px-4 py-2 flex justify-between items-center">
            <div class="flex items-center gap-2 text-sm text-gray-600 truncate">
                <i class="fas fa-reply text-teal-500"></i>
                <span class="font-bold text-teal-700" id="reply-to-user">User</span>
                <span class="text-gray-400 truncate max-w-xs" id="reply-to-text">...</span>
            </div>
            <button onclick="cancelReply()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
        </div>

        <footer class="bg-white p-4 border-t relative">
            <input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleImageUpload()">

            <div class="flex items-end gap-2 bg-gray-100 p-2 rounded-2xl border border-transparent focus-within:border-teal-300 focus-within:bg-white transition-all">
                <button onclick="document.getElementById('image-input').click()" class="p-2 text-gray-400 hover:text-teal-600 transition rounded-full hover:bg-gray-100">
                    <i class="fas fa-image text-lg"></i>
                </button>
                
                <button id="record-btn" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()" class="p-2 text-gray-400 hover:text-red-500 transition rounded-full hover:bg-gray-100">
                    <i class="fas fa-microphone text-lg"></i>
                </button>

                <textarea id="message-input" rows="1" class="flex-1 bg-transparent focus:outline-none py-2 px-1 text-gray-700 resize-none max-h-32" placeholder="Type a message..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>

                <button onclick="sendTextMessage()" class="bg-teal-600 hover:bg-teal-700 text-white rounded-xl p-3 w-10 h-10 flex items-center justify-center shadow-sm transition transform active:scale-95">
                    <i class="fas fa-paper-plane text-sm"></i>
                </button>
            </div>
        </footer>
    </div>

    <script>
        const socket = io('https://chatsocket-6koy.onrender.com', { transports: ['websocket'] });
        
        // State
        let currentUser = "";
        let currentRoom = "";
        let replyContext = null; // { id, user, text }
        let mediaRecorder;
        let audioChunks = [];
        const messageStore = {}; // Local memory of messages to handle reactions

        // --- Initialization ---
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const roomParam = params.get('room');
            if (roomParam) {
                // If URL has room, show logic to auto-join or just prep UI
                document.getElementById('landing-page').querySelector('h1').innerText = "Join ChatWithCNR";
                document.getElementById('landing-page').querySelector('button').innerHTML = '<i class="fas fa-sign-in-alt"></i> Join Room';
                currentRoom = roomParam;
            }
        };

        function createChat() {
            const username = document.getElementById('username-input').value.trim();
            if (!username) return alert("Please enter a username.");

            currentUser = username;
            
            // Generate Room ID if not present
            if (!currentRoom) {
                currentRoom = Math.random().toString(36).substring(2, 10) + Date.now().toString(36);
                // Update URL
                const newUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}?room=${currentRoom}`;
                window.history.pushState({path: newUrl}, '', newUrl);
            }

            // UI Transition
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('chat-page').classList.replace('hidden', 'flex');
            document.getElementById('share-link-text').innerText = window.location.href;

            // Connect
            socket.emit('join_room', { username: currentUser, room: currentRoom });
        }

        function leaveChat() {
            window.location.href = window.location.pathname;
        }

        function copyFullLink() {
            navigator.clipboard.writeText(window.location.href);
            alert("Secure Link Copied!");
        }

        // --- Protocol Wrapper (The "Secret Sauce") ---
        // Since backend only emits 'message', 'image', 'voice', we use 'message' 
        // as a transport for complex data (text with IDs, reactions, replies).

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function sendTextMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;

            const payload = {
                type: 'text',
                id: generateId(),
                content: text,
                replyTo: replyContext, // attach reply info
                timestamp: new Date().toISOString()
            };

            // Send as stringified JSON inside the 'msg' field
            socket.emit('message', { msg: JSON.stringify(payload) });

            input.value = "";
            input.style.height = 'auto';
            cancelReply();
        }

        function sendReactionToMessage(msgId, emoji) {
            // We can't update the DB, so we broadcast a "reaction event" disguised as a message
            const payload = {
                type: 'reaction-update',
                targetId: msgId,
                emoji: emoji,
                fromUser: currentUser
            };
            socket.emit('message', { msg: JSON.stringify(payload) });
        }

        // --- Socket Listeners ---

        socket.on('message', (data) => {
            // Server sends { user: "...", msg: "..." }
            if (data.user === "Server") {
                renderSystemMessage(data.msg);
                return;
            }

            try {
                // Try to parse our custom protocol
                const payload = JSON.parse(data.msg);
                
                if (payload.type === 'text') {
                    renderMessage(data.user, payload);
                } else if (payload.type === 'reaction-update') {
                    handleIncomingReaction(payload);
                }
            } catch (e) {
                // Fallback for plain text (legacy or direct backend testing)
                renderMessage(data.user, { type: 'text', id: generateId(), content: data.msg });
            }
        });

        socket.on('image', (data) => {
            // Images don't support our custom JSON wrapper easily without base64 bloat, 
            // so we render them simply, but generate a local ID so we can react to them loosely.
            renderMessage(data.user, { type: 'image', id: generateId(), content: data.img });
        });

        socket.on('voice', (data) => {
            renderMessage(data.user, { type: 'voice', id: generateId(), content: data.voice });
        });

        // --- UI Rendering ---

        function renderMessage(user, data) {
            const container = document.getElementById('messages-container');
            const isMe = user === currentUser;
            const msgId = data.id || generateId();
            
            // Save to local store for reaction lookup
            messageStore[msgId] = { user, ...data };

            const wrapper = document.createElement('div');
            wrapper.id = `msg-${msgId}`;
            wrapper.className = `flex w-full group ${isMe ? 'justify-end' : 'justify-start'} fade-in mb-4 relative`;

            // Avatar placeholder
            const avatar = `<div class="w-8 h-8 rounded-full bg-gradient-to-tr from-teal-400 to-blue-500 flex items-center justify-center text-white text-xs font-bold mr-2 shadow-sm select-none">${user.substring(0,2).toUpperCase()}</div>`;

            // Content Body
            let contentHtml = "";
            if (data.type === 'text') {
                contentHtml = `<p class="whitespace-pre-wrap">${data.content}</p>`;
            } else if (data.type === 'image') {
                contentHtml = `<img src="${data.content}" class="rounded-lg max-w-xs md:max-w-sm border border-white/20">`;
            } else if (data.type === 'voice') {
                contentHtml = `<audio controls src="${data.content}" class="h-8 w-56"></audio>`;
            }

            // Reply Block rendering
            let replyHtml = "";
            if (data.replyTo) {
                replyHtml = `
                    <div class="mb-1 text-xs border-l-2 ${isMe ? 'border-teal-200' : 'border-teal-500'} pl-2 opacity-70 cursor-pointer hover:opacity-100" onclick="scrollToMessage('${data.replyTo.id}')">
                        <span class="font-bold mr-1">${data.replyTo.user}</span>
                        <span class="truncate block">${data.replyTo.text.substring(0, 30)}...</span>
                    </div>
                `;
            }

            // Action Toolbar (Hidden by default, shows on hover)
            const actions = `
                <div class="absolute ${isMe ? '-left-14' : '-right-14'} top-0 hidden group-hover:flex gap-1 bg-white shadow-sm border rounded-full px-2 py-1 z-10">
                    <button onclick="triggerReply('${msgId}')" class="text-gray-400 hover:text-teal-600 p-1" title="Reply"><i class="fas fa-reply"></i></button>
                    <div class="relative group/react">
                        <button class="text-gray-400 hover:text-yellow-500 p-1" title="React"><i class="far fa-smile"></i></button>
                        <div class="absolute bottom-full left-0 hidden group-hover/react:flex bg-white shadow-lg rounded-lg p-1 gap-1 mb-1">
                            ${['ðŸ‘','â¤ï¸','ðŸ˜‚','ðŸ˜®','ðŸ”¥'].map(e => 
                                `<button onclick="sendReactionToMessage('${msgId}', '${e}')" class="hover:scale-125 transition p-1 text-lg">${e}</button>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;

            // Bubble Styling
            const bubbleClass = isMe 
                ? 'bg-teal-600 text-white rounded-2xl rounded-tr-none' 
                : 'bg-white text-gray-800 border border-gray-100 shadow-sm rounded-2xl rounded-tl-none';

            wrapper.innerHTML = `
                ${!isMe ? avatar : ''}
                <div class="relative max-w-[80%] md:max-w-[60%]">
                    <div class="${bubbleClass} px-4 py-3 relative">
                        ${replyHtml}
                        ${contentHtml}
                        <div class="text-[10px] opacity-50 text-right mt-1">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                    <div id="reactions-${msgId}" class="flex gap-1 absolute -bottom-3 ${isMe ? 'right-0' : 'left-0'}"></div>
                    ${actions}
                </div>
            `;

            container.appendChild(wrapper);
            container.scrollTop = container.scrollHeight;
        }

        function renderSystemMessage(msg) {
            const container = document.getElementById('messages-container');
            const div = document.createElement('div');
            div.className = "flex justify-center my-2";
            div.innerHTML = `<span class="bg-gray-100 text-gray-500 text-xs px-3 py-1 rounded-full border border-gray-200">${msg}</span>`;
            container.appendChild(div);
        }

        function handleIncomingReaction(payload) {
            // payload: { targetId, emoji, fromUser }
            const reactionContainer = document.getElementById(`reactions-${payload.targetId}`);
            if (reactionContainer) {
                const badge = document.createElement('div');
                badge.className = "bg-white border text-xs rounded-full px-1 shadow-sm reaction-anim cursor-default";
                badge.title = `Reacted by ${payload.fromUser}`;
                badge.innerText = payload.emoji;
                reactionContainer.appendChild(badge);
            }
        }

        // --- Interaction Logic ---

        function triggerReply(msgId) {
            const original = messageStore[msgId];
            if (!original) return;

            replyContext = {
                id: msgId,
                user: original.user,
                text: original.type === 'text' ? original.content : '[Media]'
            };

            document.getElementById('reply-preview').classList.replace('hidden', 'flex');
            document.getElementById('reply-to-user').innerText = replyContext.user;
            document.getElementById('reply-to-text').innerText = replyContext.text;
            document.getElementById('message-input').focus();
        }

        function cancelReply() {
            replyContext = null;
            document.getElementById('reply-preview').classList.replace('flex', 'hidden');
        }

        function scrollToMessage(id) {
            const el = document.getElementById(`msg-${id}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.classList.add('bg-teal-50'); // Highlight effect
                setTimeout(() => el.classList.remove('bg-teal-50'), 1000);
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendTextMessage();
            }
        }

        // --- Media Handling (Images/Voice) ---
        
        function handleImageUpload() {
            const file = document.getElementById('image-input').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => socket.emit('image', { img: e.target.result });
                reader.readAsDataURL(file);
            }
        }

        async function startRecording() {
            const btn = document.getElementById('record-btn');
            btn.classList.add('text-red-600', 'recording-active');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.start();
            } catch (err) {
                alert("Microphone access denied.");
                btn.classList.remove('text-red-600', 'recording-active');
            }
        }

        function stopRecording() {
            const btn = document.getElementById('record-btn');
            btn.classList.remove('text-red-600', 'recording-active');
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onloadend = () => socket.emit('voice', { voice: reader.result });
                    reader.readAsDataURL(blob);
                };
            }
        }
    </script>
</body>
</html>
